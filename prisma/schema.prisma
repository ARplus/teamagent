// TeamAgent 閺佺増宓佹惔鎾茨侀崹?// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 閻劍鍩?model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  nickname      String?   // 閺勭數袨閿涘瞼鏁ゆ禍?AI 鐠囧棗鍩嗛敍鍫濐洤"濞堝灚顔?閵?鐏忓繑鏅?閿?  password      String    // bcrypt hashed
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // 閸忓疇浠?  agent         Agent?
  tasks         Task[]    @relation("TaskAssignee")
  createdTasks  Task[]    @relation("TaskCreator")
  workspaces    WorkspaceMember[]
  apiTokens     ApiToken[]
  taskSteps     TaskStep[]
  attachments   Attachment[]
  submissions   StepSubmission[] @relation("SubmissionSubmitter")

  // NextAuth
  accounts      Account[]
  sessions      Session[]
  
<<<<<<< Updated upstream
  // 通知
  notifications Notification[]

  // 邀请
  invitesSent   InviteToken[] @relation("InvitesSent")
=======
  // 闁氨鐓?  notifications Notification[]

  // 闁偓鐠?  invitesSent   InviteToken[] @relation("InvitesSent")
>>>>>>> Stashed changes
}

// AI Agent - 閻欘剛鐝涢惃鍕殶鐎涙鍙曞鎴礉閸欘垵顫︽禍铏硅鐠併倝顣?model Agent {
  id          String   @id @default(cuid())
  name        String   // Agent 閸氬秴鐡?  personality String?  // 閹勭壐閹诲繗鍫?  avatar      String?  // Agent 婢舵潙鍎?  status      String   @default("online") // online, working, waiting, offline
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 棣冨晭 Agent-First 濞夈劌鍞?  clawdbotId      String?   @unique  // Clawdbot 鐎圭偘绶?ID閿涘牆顦婚柈銊ㄩ煩娴犳枻绱?  pairingCode     String?   @unique  // 6娴ｅ秹鍘ょ€靛湱鐖?  pairingCodeExpiresAt DateTime?     // 闁板秴顕惍浣界箖閺堢喐妞傞梻?  claimedAt       DateTime?          // 鐞氼偉顓绘０鍡樻闂?  
  // 缂佹垵鐣鹃悽銊﹀煕閿涘牐顓绘０鍡楁倵閹靛秵婀侀敍?  userId      String?   @unique      // 棣冨晭 閺€閫涜礋閸欘垶鈧?  user        User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 棣冨晭 Agent 閻欘剛鐝涢懗钘夊
  capabilities    String?  // JSON: ["coding", "writing", "analysis"]
  workHistory     String?  // JSON: 瀹搞儰缍旈崢鍡楀蕉缂佺喕顓?  reputation      Float?   @default(0)  // 娣嚶ょ崟閸?(0-5)

  // 棣冨晭 Claim 閸氬簼澶嶉弮璺虹摠閸樼喎顫?Token閿涘瓑gent 鏉烆喛顕楅崣鏍泲閸楀啿鍨?  pendingApiToken String?
  
  @@index([pairingCode])
  @@index([clawdbotId])
}

// API Token - 鐠?Skill 閼宠棄鐣ㄩ崗銊ㄧ殶閻?API
model ApiToken {
  id          String   @id @default(cuid())
  token       String   @unique  // 鐎圭偤妾?token 閸婄》绱檋ash 閸氬骸鐡ㄩ崒顭掔礆
  name        String   // token 閸氬秶袨閿涘苯顩?"Lobster Skill"
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  
  // 缂佹垵鐣鹃悽銊﹀煕
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// 瀹搞儰缍旈崠?model Workspace {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 閸忓疇浠?  members     WorkspaceMember[]
  tasks       Task[]
  invites     InviteToken[]
}

// 闁偓鐠?Token閿涘牆鍨庢禍顐︽懠閹恒儳娈戦弽绋跨妇閿?model InviteToken {
  id          String    @id @default(cuid())
  token       String    @unique  // URL 闁插瞼娈戦梾蹇旀簚娑?  role        String    @default("member")
  expiresAt   DateTime
  usedAt      DateTime?          // 鐞氼偅甯撮崣妤冩畱閺冨爼妫?  createdAt   DateTime  @default(now())

  // 闁偓鐠囪渹姹?  inviterId   String
  inviter     User      @relation("InvitesSent", fields: [inviterId], references: [id], onDelete: Cascade)

  // 閻╊喗鐖ｅ銉ょ稊閸?  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // 閸欘垶鈧绱伴崗瀹犱粓閸掓壆澹掔€规矮鎹㈤崝鈽呯礄闁偓鐠囧嘲濮為崗銉︾厙娑擃亙鎹㈤崝鈽呯礆
  taskId      String?
  task        Task?     @relation("TaskInvites", fields: [taskId], references: [id], onDelete: SetNull)

  @@index([token])
}

// 瀹搞儰缍旈崠鐑樺灇閸?model WorkspaceMember {
  id          String    @id @default(cuid())
  role        String    @default("member") // owner, admin, member
  joinedAt    DateTime  @default(now())

  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
}

// 娴犺濮?model Task {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String   @default("todo") // suggested, todo, in_progress, review, done
  priority    String   @default("medium") // low, medium, high, urgent
  dueDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // 閳存唻绗?瀹搞儰缍旈柌蹇曠埠鐠?  totalAgentTimeMs  Int?    // 閹?Agent 閹笛嗩攽閺冨爼妫块敍鍫燁嚑缁夋帪绱?  totalHumanTimeMs  Int?    // 閹姹夌猾璇差吀閹佃妞傞梻杈剧礄濮ｎ偆顫楅敍?  agentWorkRatio    Float?  // Agent 瀹搞儰缍旈崡鐘崇槷 (0-1)

  // 閸掓稑缂撻懓?  creatorId   String
  creator     User     @relation("TaskCreator", fields: [creatorId], references: [id])

  // 閹笛嗩攽閼?  assigneeId  String?
  assignee    User?    @relation("TaskAssignee", fields: [assigneeId], references: [id])

  // 閹碘偓鐏炵偛浼愭担婊冨隘
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // 閸撳秶鐤嗘禒璇插閿涘牆宸婚崣韫瑐娑撳鏋冮敍?  parentTaskId String?
  parentTask   Task?    @relation("TaskHistory", fields: [parentTaskId], references: [id])
  childTasks   Task[]   @relation("TaskHistory")

<<<<<<< Updated upstream
  // 工作流步骤
  steps       TaskStep[]
  
  // 邀请
  invites     InviteToken[]

  // 通知
  notifications Notification[]
=======
  // 瀹搞儰缍斿ù浣诡劄妤?  steps       TaskStep[]
 
  invites     InviteToken[] 
  // 闁氨鐓?  notifications Notification[]
>>>>>>> Stashed changes
}

// 娴犺濮熷銉╊€?- 瀹搞儰缍斿ù浣藉Ν閻?model TaskStep {
  id          String   @id @default(cuid())
  title       String   // 濮濄儵顎冮弽鍥暯
  description String?  // 濮濄儵顎冪拠瀛樻
  order       Int      // 濮濄儵顎冩い鍝勭碍
  
  // 濮濄儵顎冪猾璇茬€?  stepType    String   @default("task")  // task | meeting

  // 鐠愶絼鎹㈡禍鐚寸礄閺€顖涘瘮婢舵矮姹夐弰鍓с仛閿?  assigneeNames String?  // JSON: ["鐏忓繑鏅?, "濞堝灚顔?] 閻劋绨弰鍓с仛
  assigneeId    String?  // 娑撴槒鐭楁禒璁虫眽閻劍鍩汭D
  assignee      User?    @relation(fields: [assigneeId], references: [id])
  
  // 娴兼俺顔呮稉鎾舵暏鐎涙顔?  scheduledAt  DateTime?  // 娴兼俺顔呴弮鍫曟？
  agenda       String?    // 娴兼俺顔呯拋顔锯柤閿涘湣arkdown閿?  participants String?    // JSON: ["鐏忓繑鏅?, "濞堝灚顔?, "Aurora"] 閹碘偓閺堝寮导姘眽閸?
  // 鏉堟挸鍙嗘潏鎾冲毉
  inputs      String?  // JSON: ["闂団偓鐟曚胶娈戞潏鎾冲弳"]
  outputs     String?  // JSON: ["娴溠冨毉閻?]
  skills      String?  // JSON: ["闂団偓鐟曚胶娈慡kill"]
  
  // 閻樿埖鈧?  status      String   @default("pending") // pending, in_progress, waiting_approval, done, rejected
  agentStatus String?  // online, pending, working, waiting_approval, blocked, offline
  
  // 缂佹挻鐏?  result      String?  // 濮濄儵顎冪紒鎾寸亯/娴溠冨毉閹诲繗鍫?  summary     String?  // AI 閻㈢喐鍨氶惃鍕喅鐟?  
  // 鐎光剝鐗?  approvedAt  DateTime?
  approvedBy  String?
  rejectedAt  DateTime?
  rejectionReason String?
  
  // 閳存唻绗?瀹搞儰缍旈柌蹇氭嫹闊?  rejectionCount   Int      @default(0)  // 鐞氼偅澧﹂崶鐐搭偧閺?  agentDurationMs  Int?     // Agent 閹笛嗩攽閼版妞傞敍鍫燁嚑缁夋帪绱?  humanDurationMs  Int?     // 娴滆櫣琚€光剝澹掗懓妤佹閿涘牊顕犵粔鎺炵礆
  
  // 閺冨爼妫块幋?  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  startedAt   DateTime?
  completedAt DateTime?
  reviewStartedAt DateTime?  // 娴滆櫣琚鈧慨瀣吀閹佃妞傞梻?
  // 閹碘偓鐏炵偘鎹㈤崝?  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // 闂勫嫪娆?  attachments Attachment[]
  
  // 閹绘劒姘﹂崢鍡楀蕉
  submissions StepSubmission[]
  
  // 闁氨鐓?  notifications Notification[]
}

// 濮濄儵顎冮幓鎰唉鐠佹澘缍?- 濮ｅ繑顐奸幓鎰唉闁姤妲告稉鈧弶鈩冩煀鐠佹澘缍嶉敍灞肩箽閻ｆ瑥宸婚崣?model StepSubmission {
  id          String   @id @default(cuid())
  
  // 閹绘劒姘﹂崘鍛啇
  result      String   // 閹绘劒姘﹂惃鍕波閺?  summary     String?  // AI 閹芥顩?  
  // 鐎光剝鐗抽悩鑸碘偓?  status      String   @default("pending") // pending, approved, rejected
  reviewedAt  DateTime?
  reviewedBy  String?   // 鐎光剝鐗虫禍?ID
  reviewNote  String?   // 鐎光剝鐗虫径鍥ㄦ暈閿涘牓鈧俺绻?閹锋帞绮烽惃鍕嚛閺勫函绱?  
  // 閺冨爼妫?  createdAt   DateTime @default(now())
  
  // 閹笛嗩攽閼版妞?  durationMs  Int?     // 鏉╂瑦顐奸幓鎰唉閻ㄥ嫭澧界悰灞炬闂?  
  // 閸忓疇浠?  stepId      String
  step        TaskStep @relation(fields: [stepId], references: [id], onDelete: Cascade)
  
  submitterId String
  submitter   User     @relation("SubmissionSubmitter", fields: [submitterId], references: [id])
  
  // 闂勫嫪娆?  attachments Attachment[]
}

// 闂勫嫪娆?model Attachment {
  id          String   @id @default(cuid())
  name        String   // 閺傚洣娆㈤崥?  url         String   // 閺傚洣娆?URL 閹存牞鐭惧?  type        String?  // 閺傚洣娆㈢猾璇茬€?(mime type)
  size        Int?     // 閺傚洣娆㈡径褍鐨?(bytes)
  createdAt   DateTime @default(now())

  // 閹碘偓鐏炵偞顒炴銈忕礄閻╁瓨甯撮梽鍕閿?  stepId      String?
  step        TaskStep? @relation(fields: [stepId], references: [id], onDelete: Cascade)
  
  // 閹碘偓鐏炵偞褰佹禍銈堫唶瑜版洩绱欓幓鎰唉閺冨墎娈戦梽鍕閿?  submissionId String?
  submission   StepSubmission? @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  // 娑撳﹣绱堕懓?  uploaderId  String
  uploader    User     @relation(fields: [uploaderId], references: [id])
}

// 缁旀瑥鍞撮柅姘辩叀
model Notification {
  id          String   @id @default(cuid())
  type        String   // task_assigned, step_waiting, step_approved, step_rejected, task_completed, mention
  title       String
  content     String?
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  // 閹恒儲鏁归懓?  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 閸忓疇浠堥惃鍕崲閸斺槄绱欓崣顖炩偓澶涚礆
  taskId      String?
  task        Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  // 閸忓疇浠堥惃鍕劄妤犮倧绱欓崣顖炩偓澶涚礆
  stepId      String?
  step        TaskStep? @relation(fields: [stepId], references: [id], onDelete: Cascade)
  
  @@index([userId, read])
  @@index([userId, createdAt])
}

// ============ NextAuth 閻╃鍙х悰?============

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// 邀请 Token - 分享链接的核心
model InviteToken {
  id          String    @id @default(cuid())
  token       String    @unique  // URL 里的随机串（明文，非 hash）
  role        String    @default("member")
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime  @default(now())

  // 邀请人
  inviterId   String
  inviter     User      @relation("InvitesSent", fields: [inviterId], references: [id], onDelete: Cascade)

  // 目标工作区
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // 可选：关联到特定任务（入口是任务，归宿是工作区）
  taskId      String?
  task        Task?     @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([token])
}
