// TeamAgent æ•°æ®åº“æ¨¡å‹
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ç”¨æˆ·
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  nickname      String?   // æ˜µç§°ï¼Œç”¨äº AI è¯†åˆ«ï¼ˆå¦‚"æ®µæ®µ"ã€"å°æ•"ï¼‰
  password      String    // bcrypt hashed
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // å…³è”
  agent         Agent?
  tasks         Task[]    @relation("TaskAssignee")
  createdTasks  Task[]    @relation("TaskCreator")
  workspaces    WorkspaceMember[]
  apiTokens     ApiToken[]
  taskSteps     TaskStep[]
  attachments   Attachment[]
  submissions   StepSubmission[] @relation("SubmissionSubmitter")

  // NextAuth
  accounts      Account[]
  sessions      Session[]
  
  // é€šçŸ¥
  notifications Notification[]
  invitesSent     InviteToken[] @relation("InvitesSent")
  invitesReceived InviteToken[] @relation("InvitesReceived")
}

// AI Agent - ç‹¬ç«‹çš„æ•°å­—å…¬æ°‘ï¼Œå¯è¢«äººç±»è®¤é¢†
model Agent {
  id          String   @id @default(cuid())
  name        String   // Agent åå­—
  personality String?  // æ€§æ ¼æè¿°
  avatar      String?  // Agent å¤´åƒ
  status      String   @default("online") // online, working, waiting, offline
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // ğŸ†• Agent-First æ³¨å†Œ
  clawdbotId      String?   @unique  // Clawdbot å®ä¾‹ IDï¼ˆå¤–éƒ¨èº«ä»½ï¼‰
  pairingCode     String?   @unique  // 6ä½é…å¯¹ç 
  pairingCodeExpiresAt DateTime?     // é…å¯¹ç è¿‡æœŸæ—¶é—´
  claimedAt       DateTime?          // è¢«è®¤é¢†æ—¶é—´
  
  // ç»‘å®šç”¨æˆ·ï¼ˆè®¤é¢†åæ‰æœ‰ï¼‰
  userId      String?   @unique      // ğŸ†• æ”¹ä¸ºå¯é€‰
  user        User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // ğŸ†• Agent ç‹¬ç«‹èƒ½åŠ›
  capabilities    String?  // JSON: ["coding", "writing", "analysis"]
  workHistory     String?  // JSON: å·¥ä½œå†å²ç»Ÿè®¡
  reputation      Float?   @default(0)  // ä¿¡èª‰åˆ† (0-5)

  // ğŸ†• Claim åä¸´æ—¶å­˜åŸå§‹ Tokenï¼ŒAgent è½®è¯¢å–èµ°å³åˆ 
  pendingApiToken String?
  
  @@index([pairingCode])
  @@index([clawdbotId])
}

// API Token - è®© Skill èƒ½å®‰å…¨è°ƒç”¨ API
model ApiToken {
  id          String   @id @default(cuid())
  token       String   @unique  // å®é™… token å€¼ï¼ˆhash åå­˜å‚¨ï¼‰
  name        String   // token åç§°ï¼Œå¦‚ "Lobster Skill"
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  
  // ç»‘å®šç”¨æˆ·
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// å·¥ä½œåŒº
model Workspace {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // å…³è”
  members     WorkspaceMember[]
  tasks       Task[]
  invites     InviteToken[]
}

// é‚€è¯· Tokenï¼ˆåˆ†äº«é“¾æ¥æ ¸å¿ƒï¼‰
model InviteToken {
  id          String    @id @default(cuid())
  token       String    @unique
  role        String    @default("member")
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime  @default(now())

  inviterId   String
  inviter     User      @relation("InvitesSent", fields: [inviterId], references: [id], onDelete: Cascade)

  // æ¥å—é‚€è¯·çš„äººï¼ˆæ¥å—æ—¶è®°å½•ï¼Œæ°¸ä¹…ä¿å­˜ä»»åŠ¡å¯è§æ€§ï¼‰
  inviteeId   String?
  invitee     User?     @relation("InvitesReceived", fields: [inviteeId], references: [id], onDelete: SetNull)

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  taskId      String?
  task        Task?     @relation("TaskInvites", fields: [taskId], references: [id], onDelete: SetNull)

  @@index([token])
  @@index([inviteeId, taskId])
}

// å·¥ä½œåŒºæˆå‘˜
model WorkspaceMember {
  id          String    @id @default(cuid())
  role        String    @default("member") // owner, admin, member
  joinedAt    DateTime  @default(now())

  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
}

// ä»»åŠ¡
model Task {
  id          String   @id @default(cuid())
  title       String
  description String?
  status      String   @default("todo") // suggested, todo, in_progress, review, done
  priority    String   @default("medium") // low, medium, high, urgent
  mode        String   @default("solo")   // soloï¼ˆAIå›¢é˜Ÿå†…éƒ¨ï¼‰| teamï¼ˆå¤–éƒ¨äººç±»åä½œï¼‰
  dueDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // â±ï¸ å·¥ä½œé‡ç»Ÿè®¡
  totalAgentTimeMs  Int?    // æ€» Agent æ‰§è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  totalHumanTimeMs  Int?    // æ€»äººç±»å®¡æ‰¹æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  agentWorkRatio    Float?  // Agent å·¥ä½œå æ¯” (0-1)

  // ä»»åŠ¡å®Œæˆæ€»ç»“
  autoSummary       String?  // ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆçš„å®Œæˆæ‘˜è¦
  creatorComment    String?  // å‘èµ·è€…ç»“è¯­ï¼ˆäººç±»å¡«å†™ï¼‰

  // åˆ›å»ºè€…
  creatorId   String
  creator     User     @relation("TaskCreator", fields: [creatorId], references: [id])

  // æ‰§è¡Œè€…
  assigneeId  String?
  assignee    User?    @relation("TaskAssignee", fields: [assigneeId], references: [id])

  // æ‰€å±å·¥ä½œåŒº
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  // å‰ç½®ä»»åŠ¡ï¼ˆå†å²ä¸Šä¸‹æ–‡ï¼‰
  parentTaskId String?
  parentTask   Task?    @relation("TaskHistory", fields: [parentTaskId], references: [id])
  childTasks   Task[]   @relation("TaskHistory")

  // å·¥ä½œæµæ­¥éª¤
  steps       TaskStep[]
  invites     InviteToken[] @relation("TaskInvites")
  
  // é€šçŸ¥
  notifications Notification[]
}

// ä»»åŠ¡æ­¥éª¤ - å·¥ä½œæµèŠ‚ç‚¹
model TaskStep {
  id          String   @id @default(cuid())
  title       String   // æ­¥éª¤æ ‡é¢˜
  description String?  // æ­¥éª¤è¯´æ˜
  order       Int      // æ­¥éª¤é¡ºåº
  
  // æ­¥éª¤ç±»å‹
  stepType    String   @default("task")  // task | meeting

  // è´£ä»»äººï¼ˆæ”¯æŒå¤šäººæ˜¾ç¤ºï¼‰
  assigneeNames String?  // JSON: ["å°æ•", "æ®µæ®µ"] ç”¨äºæ˜¾ç¤º
  assigneeId    String?  // ä¸»è´£ä»»äººç”¨æˆ·ID
  assignee      User?    @relation(fields: [assigneeId], references: [id])
  
  // ä¼šè®®ä¸“ç”¨å­—æ®µ
  scheduledAt  DateTime?  // ä¼šè®®æ—¶é—´
  agenda       String?    // ä¼šè®®è®®ç¨‹ï¼ˆMarkdownï¼‰
  participants String?    // JSON: ["å°æ•", "æ®µæ®µ", "Aurora"] æ‰€æœ‰å‚ä¼šäººå

  // è¾“å…¥è¾“å‡º
  inputs      String?  // JSON: ["éœ€è¦çš„è¾“å…¥"]
  outputs     String?  // JSON: ["äº§å‡ºç‰©"]
  skills      String?  // JSON: ["éœ€è¦çš„Skill"]
  
  // å®¡æ‰¹è®¾ç½®
  requiresApproval Boolean @default(true)  // false = Agent æäº¤åè‡ªåŠ¨é€šè¿‡ï¼Œæ— éœ€äººå·¥å®¡æ‰¹

  // çŠ¶æ€
  status      String   @default("pending") // pending, in_progress, waiting_approval, done, rejected
  agentStatus String?  // online, pending, working, waiting_approval, blocked, offline
  
  // ç»“æœ
  result      String?  // æ­¥éª¤ç»“æœ/äº§å‡ºæè¿°
  summary     String?  // AI ç”Ÿæˆçš„æ‘˜è¦
  
  // å®¡æ ¸
  approvedAt  DateTime?
  approvedBy  String?
  rejectedAt  DateTime?
  rejectionReason String?
  
  // ç”³è¯‰æœºåˆ¶
  appealText       String?   // Agent çš„ç”³è¯‰ç†ç”±
  appealStatus     String?   // null | "pending" | "upheld" | "dismissed"
  appealedAt       DateTime? // ç”³è¯‰æ—¶é—´
  appealResolvedAt DateTime? // ç”³è¯‰è£å®šæ—¶é—´
  
  // â±ï¸ å·¥ä½œé‡è¿½è¸ª
  rejectionCount   Int      @default(0)  // è¢«æ‰“å›æ¬¡æ•°
  agentDurationMs  Int?     // Agent æ‰§è¡Œè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
  humanDurationMs  Int?     // äººç±»å®¡æ‰¹è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
  
  // æ—¶é—´æˆ³
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  startedAt   DateTime?
  completedAt DateTime?
  reviewStartedAt DateTime?  // äººç±»å¼€å§‹å®¡æ‰¹æ—¶é—´

  // æ‰€å±ä»»åŠ¡
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // é™„ä»¶
  attachments Attachment[]
  
  // æäº¤å†å²
  submissions StepSubmission[]
  
  // é€šçŸ¥
  notifications Notification[]

  @@index([assigneeId, status])  // Solo Mode é«˜é¢‘æŸ¥è¯¢ä¼˜åŒ–ï¼ˆCodeReviewer å»ºè®®ï¼‰
  @@index([taskId, order])
}

// æ­¥éª¤æäº¤è®°å½• - æ¯æ¬¡æäº¤éƒ½æ˜¯ä¸€æ¡æ–°è®°å½•ï¼Œä¿ç•™å†å²
model StepSubmission {
  id          String   @id @default(cuid())
  
  // æäº¤å†…å®¹
  result      String   // æäº¤çš„ç»“æœ
  summary     String?  // AI æ‘˜è¦
  
  // å®¡æ ¸çŠ¶æ€
  status      String   @default("pending") // pending, approved, rejected
  reviewedAt  DateTime?
  reviewedBy  String?   // å®¡æ ¸äºº ID
  reviewNote  String?   // å®¡æ ¸å¤‡æ³¨ï¼ˆé€šè¿‡/æ‹’ç»çš„è¯´æ˜ï¼‰
  
  // æ—¶é—´
  createdAt   DateTime @default(now())
  
  // æ‰§è¡Œè€—æ—¶
  durationMs  Int?     // è¿™æ¬¡æäº¤çš„æ‰§è¡Œæ—¶é—´
  
  // å…³è”
  stepId      String
  step        TaskStep @relation(fields: [stepId], references: [id], onDelete: Cascade)
  
  submitterId String
  submitter   User     @relation("SubmissionSubmitter", fields: [submitterId], references: [id])
  
  // é™„ä»¶
  attachments Attachment[]
}

// é™„ä»¶
model Attachment {
  id          String   @id @default(cuid())
  name        String   // æ–‡ä»¶å
  url         String   // æ–‡ä»¶ URL æˆ–è·¯å¾„
  type        String?  // æ–‡ä»¶ç±»å‹ (mime type)
  size        Int?     // æ–‡ä»¶å¤§å° (bytes)
  createdAt   DateTime @default(now())

  // æ‰€å±æ­¥éª¤ï¼ˆç›´æ¥é™„ä»¶ï¼‰
  stepId      String?
  step        TaskStep? @relation(fields: [stepId], references: [id], onDelete: Cascade)
  
  // æ‰€å±æäº¤è®°å½•ï¼ˆæäº¤æ—¶çš„é™„ä»¶ï¼‰
  submissionId String?
  submission   StepSubmission? @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  // ä¸Šä¼ è€…
  uploaderId  String
  uploader    User     @relation(fields: [uploaderId], references: [id])
}

// ç«™å†…é€šçŸ¥
model Notification {
  id          String   @id @default(cuid())
  type        String   // task_assigned, step_waiting, step_approved, step_rejected, task_completed, mention
  title       String
  content     String?
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  // æ¥æ”¶è€…
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // å…³è”çš„ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
  taskId      String?
  task        Task?    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  // å…³è”çš„æ­¥éª¤ï¼ˆå¯é€‰ï¼‰
  stepId      String?
  step        TaskStep? @relation(fields: [stepId], references: [id], onDelete: Cascade)
  
  @@index([userId, read])
  @@index([userId, createdAt])
}

// ============ NextAuth ç›¸å…³è¡¨ ============

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
